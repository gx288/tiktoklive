name: Check TikTok Live & Notify + Trigger Record

on:
  schedule:
    - cron: '*/5 * * * *'  # M·ªói 5 ph√∫t
  workflow_dispatch:

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install TikTokLive python-telegram-bot requests

      - name: Check live users & send Telegram
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TIKTOK_USERS: "charlidamelio youruser1 youruser2"  # Thay username th·∫≠t, c√°ch nhau space
        run: |
          python - <<EOF
          import asyncio, os
          from TikTokLive import TikTokLiveClient
          from telegram import Bot

          TOKEN = os.getenv("TELEGRAM_TOKEN")
          CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
          USERS = os.getenv("TIKTOK_USERS", "").split()

          bot = Bot(token=TOKEN)
          notified = set()  # Tr√°nh spam notify

          async def check_user(user):
              try:
                  client = TikTokLiveClient(unique_id=user)
                  info = await client.is_live()
                  if info.get("status", 0) == 2 and user not in notified:
                      msg = f"üî¥ @{user} ƒëang live ngay b√¢y gi·ªù! B·∫Øt ƒë·∫ßu ghi video..."
                      await bot.send_message(chat_id=CHAT_ID, text=msg)
                      print(f"New live detected for {user}")
                      notified.add(user)
                  elif info.get("status", 0) != 2 and user in notified:
                      notified.remove(user)
              except Exception as e:
                  print(f"Error checking {user}: {e}")

          asyncio.run(asyncio.gather(*(check_user(u) for u in USERS)))
          EOF

      - name: Trigger record workflow if needed
        if: always()  # Ch·∫°y d√π check fail
        run: echo "Trigger logic here if you want auto-record, but for now manual or use separate"
