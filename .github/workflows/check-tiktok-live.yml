name: Check TikTok Live & Trigger Record

on:
  schedule:
    - cron: '*/5 * * * *'  # Mỗi 5 phút
  workflow_dispatch:

jobs:
  check-and-trigger:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install TikTokLive requests

      - name: Check live & trigger record workflow
        env:
          TIKTOK_USERS: "jack.vn41 charlidamelio"  # Thêm username thật bạn muốn theo dõi
        run: |
          python - <<EOF
          import asyncio
          import os
          import subprocess
          from TikTokLive import TikTokLiveClient

          USERS = os.getenv("TIKTOK_USERS", "").split()

          async def check_user(username):
              try:
                  client = TikTokLiveClient(unique_id=username)
                  is_live_now = await client.is_live()
                  if is_live_now:
                      print(f"LIVE DETECTED: @{username}")
                      # Trigger workflow ghi video
                      dispatch_cmd = [
                          'curl', '-L', '-X', 'POST',
                          '-H', 'Accept: application/vnd.github+json',
                          '-H', f'Authorization: Bearer {os.getenv("GITHUB_TOKEN")}',
                          '-H', 'X-GitHub-Api-Version: 2022-11-28',
                          f'https://api.github.com/repos/{os.getenv("GITHUB_REPOSITORY")}/dispatches',
                          '-d', f'{{"event_type":"tiktok-live-start","client_payload":{{"user":"{username}"}}}}'
                      ]
                      subprocess.run(dispatch_cmd, check=True)
                      print(f"Triggered record for @{username}")
                  else:
                      print(f"NOT live: @{username}")
              except Exception as e:
                  print(f"Error checking @{username}: {str(e)}")

          async def main():
              tasks = [check_user(user) for user in USERS]
              await asyncio.gather(*tasks)

          asyncio.run(main())
          EOF
